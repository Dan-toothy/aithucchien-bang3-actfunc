{% extends "base.html" %}

{% block title %}{{ article.title }}{% endblock %}

{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ article.excerpt }}{% endblock %}

{% block extra_head %}
<style>
    /* Markdown Content Styles */
    .markdown-content {
        font-size: 1.125rem;
        line-height: 1.75;
        color: #374151;
    }

    .markdown-content h1 {
        font-size: 2.25rem;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #111827;
    }

    .markdown-content h2 {
        font-size: 1.875rem;
        font-weight: 600;
        margin-top: 1.75rem;
        margin-bottom: 0.75rem;
        color: #1f2937;
    }

    .markdown-content h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #374151;
    }

    .markdown-content p {
        margin-bottom: 1.25rem;
    }

    .markdown-content ul, .markdown-content ol {
        margin-left: 2rem;
        margin-bottom: 1.25rem;
    }

    .markdown-content li {
        margin-bottom: 0.5rem;
    }

    .markdown-content blockquote {
        border-left: 4px solid #667eea;
        padding-left: 1rem;
        margin: 1.5rem 0;
        font-style: italic;
        color: #6b7280;
    }

    .markdown-content pre {
        background-color: #1f2937;
        color: #f3f4f6;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 1.25rem;
    }

    .markdown-content code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
    }

    .markdown-content table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1.25rem;
    }

    .markdown-content th {
        background-color: #f9fafb;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
    }

    .markdown-content td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .markdown-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1.5rem 0;
    }

    .markdown-content a {
        color: #667eea;
        text-decoration: underline;
    }

    .markdown-content a:hover {
        color: #764ba2;
    }

    /* Reaction button styles */
    .reaction-btn {
        transition: all 0.2s;
    }

    .reaction-btn:hover {
        transform: scale(1.2);
    }

    .reaction-btn.active {
        color: #667eea;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Article Header -->
    <header class="glass-effect rounded-xl p-8 mb-8">
        <div class="mb-4">
            <a href="/tab/{{ article.file_info.tab }}" class="inline-flex items-center text-primary hover:text-secondary transition">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                {{ article.file_info.tab|title }}
            </a>
        </div>

        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
            {{ article.title }}
        </h1>

        <div class="flex flex-wrap items-center gap-4 text-gray-600">
            {% if article.author %}
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>{{ article.author }}</span>
            </div>
            {% endif %}

            {% if article.date %}
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>{{ article.date.strftime('%B %d, %Y') }}</span>
            </div>
            {% endif %}

            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span id="reading-time">5 min read</span>
            </div>
        </div>

        {% if article.tags %}
        <div class="flex flex-wrap gap-2 mt-4">
            {% for tag in article.tags %}
            <span class="px-3 py-1 text-sm font-medium bg-primary/10 text-primary rounded-full">
                #{{ tag }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <!-- Article Content -->
    <div class="glass-effect rounded-xl p-8 mb-8">
        <div class="markdown-content">
            {{ article.content_html|safe }}
        </div>
    </div>

    <!-- Reactions Section -->
    <div class="glass-effect rounded-xl p-8 mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">How did you find this article?</h3>
        <div class="flex justify-center gap-6" id="reactions" x-data="reactions()">
            <button @click="react('thumbs_up')" class="reaction-btn text-4xl" :class="{'active': hasReacted.thumbs_up}">
                üëç
                <span class="block text-sm text-gray-600 mt-1" x-text="counts.thumbs_up || 0"></span>
            </button>
            <button @click="react('heart')" class="reaction-btn text-4xl" :class="{'active': hasReacted.heart}">
                ‚ù§Ô∏è
                <span class="block text-sm text-gray-600 mt-1" x-text="counts.heart || 0"></span>
            </button>
            <button @click="react('smile')" class="reaction-btn text-4xl" :class="{'active': hasReacted.smile}">
                üòä
                <span class="block text-sm text-gray-600 mt-1" x-text="counts.smile || 0"></span>
            </button>
            <button @click="react('fire')" class="reaction-btn text-4xl" :class="{'active': hasReacted.fire}">
                üî•
                <span class="block text-sm text-gray-600 mt-1" x-text="counts.fire || 0"></span>
            </button>
            <button @click="react('hundred')" class="reaction-btn text-4xl" :class="{'active': hasReacted.hundred}">
                üíØ
                <span class="block text-sm text-gray-600 mt-1" x-text="counts.hundred || 0"></span>
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between items-center">
        <a href="/tab/{{ article.file_info.tab }}" class="inline-flex items-center text-gray-600 hover:text-primary transition">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to {{ article.file_info.tab|title }}
        </a>

        <div class="flex gap-2">
            <!-- Share buttons -->
            <button onclick="shareOnTwitter()" class="p-2 text-gray-600 hover:text-primary transition">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                </svg>
            </button>
            <button onclick="copyLink()" class="p-2 text-gray-600 hover:text-primary transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
            </button>
        </div>
    </div>
</article>
{% endblock %}

{% block extra_scripts %}
<script>
// Calculate reading time
document.addEventListener('DOMContentLoaded', function() {
    const content = document.querySelector('.markdown-content').textContent;
    const wordsPerMinute = 200;
    const words = content.trim().split(/\s+/).length;
    const readingTime = Math.ceil(words / wordsPerMinute);
    document.getElementById('reading-time').textContent = `${readingTime} min read`;
});

// Reactions functionality
function reactions() {
    return {
        counts: {{ article.reactions|default({})|tojson }},
        hasReacted: {
            thumbs_up: false,
            heart: false,
            smile: false,
            fire: false,
            hundred: false
        },

        async react(type) {
            if (this.hasReacted[type]) {
                alert('You have already reacted to this article!');
                return;
            }

            try {
                const response = await fetch('/api/article/{{ article.file_info.tab }}/{{ article.file_info.filename.replace('.md', '') }}/react', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ reaction: type })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.counts = data.reactions;
                    this.hasReacted[type] = true;
                } else if (response.status === 429) {
                    alert('You have already reacted to this article!');
                    this.hasReacted[type] = true;
                }
            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        },

        async loadReactions() {
            try {
                const response = await fetch('/api/article/{{ article.file_info.tab }}/{{ article.file_info.filename.replace('.md', '') }}/reactions');
                if (response.ok) {
                    const data = await response.json();
                    this.counts = data.reactions;
                }
            } catch (error) {
                console.error('Error loading reactions:', error);
            }
        },

        init() {
            this.loadReactions();
        }
    }
}

// Share functions
function shareOnTwitter() {
    const text = encodeURIComponent('{{ article.title }}');
    const url = encodeURIComponent(window.location.href);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
    });
}
</script>
{% endblock %}

